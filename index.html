<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Serpent</title>
    
    <!-- –ó–∞—â–∏—Ç–∞ –æ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π –≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –≤ HTML -->
    <script>
    (function() {
        'use strict';
        
        // –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π –∫–æ—à–µ–ª—å–∫–æ–≤
        const protectionLog = [];
        
        // –ó–∞—â–∏—Ç–∞ window.ethereum
        if (typeof window.ethereum !== 'undefined') {
            try {
                window._backupEthereum = window.ethereum;
                protectionLog.push('‚úÖ Ethereum provider backed up');
            } catch (e) {
                protectionLog.push('‚ö†Ô∏è Could not backup ethereum provider');
            }
        }
        
        // –ü–æ–¥–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
        const originalError = window.onerror;
        window.onerror = function(message, source, lineno, colno, error) {
            const errorStr = String(message).toLowerCase();
            const suppressKeywords = ['evmask', 'metamask', 'ethereum', 'cannot redefine property', 'runtime.lasterror'];
            
            if (suppressKeywords.some(keyword => errorStr.includes(keyword))) {
                protectionLog.push(`üõ°Ô∏è Suppressed: ${message}`);
                return true; // –ü–æ–¥–∞–≤–ª—è–µ–º –æ—à–∏–±–∫—É
            }
            
            if (originalError) {
                return originalError.apply(this, arguments);
            }
            return false;
        };
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        window.EXTENSION_PROTECTION_LOG = protectionLog;
        
        console.log('üõ°Ô∏è Emergency extension protection loaded');
    })();
    </script>
    
    <!-- –£—Å–∏–ª–µ–Ω–Ω–∞—è Content Security Policy –¥–ª—è GitHub Pages -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' https:; 
        script-src 'self' 'unsafe-inline' 'unsafe-eval' 
            https://www.gstatic.com 
            https://cdnjs.cloudflare.com 
            https://*.firebaseapp.com 
            https://*.googleapis.com 
            https://*.firebasedatabase.app
            https://*.googleusercontent.com; 
        connect-src 'self' 
            https: 
            wss: 
            https://*.googleapis.com 
            https://*.firebaseio.com 
            https://*.firebaseapp.com 
            https://*.firebasedatabase.app 
            wss://*.firebaseio.com 
            wss://*.firebasedatabase.app
            https://nexus-serpent-game-default-rtdb.europe-west1.firebasedatabase.app; 
        style-src 'self' 'unsafe-inline' https:; 
        img-src 'self' data: https: blob:; 
        font-src 'self' data: https:;
        object-src 'none';
        base-uri 'self';
        form-action 'self';
        upgrade-insecure-requests;
    ">
    
    <link rel="stylesheet" href="style.css?v=2.2">
    
    <!-- Firebase SDK –¥–ª—è Realtime Database -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, onValue, off, orderByChild, query, limitToLast } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        // –î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ
        const isProduction = window.location.hostname.includes('github.io');
        const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        
        console.log('Environment:', { isProduction, isDevelopment, hostname: window.location.hostname });
        
        // –í–∞—à–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
        const firebaseConfig = {
            apiKey: "d6A2GGfEjEvMlyiUzBuHAv8vUV5G_Mw-YIjF74ZAR4s",
            authDomain: "nexus-serpent-game.firebaseapp.com",
            databaseURL: "https://nexus-serpent-game-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "nexus-serpent-game",
            storageBucket: "nexus-serpent-game.firebasestorage.app",
            messagingSenderId: "635862426550",
            appId: "1:635862426550:web:cb46b0e57f424e58665717",
            measurementId: "G-2ZGDRYZEBH"
        };
        
        // –§—É–Ω–∫—Ü–∏—è —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        async function initializeFirebaseWithLogging() {
            try {
                console.log('Starting Firebase initialization...');
                console.log('Firebase config:', firebaseConfig);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö API
                if (!window.fetch) {
                    throw new Error('Fetch API not available');
                }
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
                const app = initializeApp(firebaseConfig);
                console.log('Firebase app initialized:', app);
                
                const database = getDatabase(app);
                console.log('Firebase database initialized:', database);
                
                // –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å —Ç–∞–π–º–∞—É—Ç–æ–º
                const testRef = ref(database, '.info/connected');
                const connectionPromise = new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('Connection test timeout'));
                    }, 15000);
                    
                    onValue(testRef, (snapshot) => {
                        clearTimeout(timeout);
                        const connected = snapshot.val();
                        console.log('Firebase connection status:', connected);
                        
                        if (connected) {
                            console.log('‚úÖ Firebase connected successfully');
                            window.firebaseConnectionStatus = 'connected';
                            resolve(true);
                        } else {
                            console.log('‚ùå Firebase not connected');
                            window.firebaseConnectionStatus = 'disconnected';
                            resolve(false);
                        }
                    }, (error) => {
                        clearTimeout(timeout);
                        reject(error);
                    });
                });
                
                await connectionPromise;
                
                // –î–µ–ª–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
                window.firebaseDB = database;
                window.firebaseFunctions = { ref, push, onValue, off, orderByChild, query, limitToLast };
                
                // –ü–æ–º–µ—á–∞–µ–º, —á—Ç–æ Firebase –≥–æ—Ç–æ–≤
                window.firebaseReady = true;
                
                // –î–∏—Å–ø–∞—Ç—á–∏–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
                window.dispatchEvent(new CustomEvent('firebaseReady'));
                
                console.log('Firebase initialization completed successfully');
                return true;
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                console.error('Error details:', {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                
                window.firebaseReady = false;
                window.firebaseConnectionStatus = 'error';
                window.dispatchEvent(new CustomEvent('firebaseError', { detail: error }));
                return false;
            }
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è GitHub Pages –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
        const initDelay = isProduction ? 3000 : 1000;
        console.log(`Waiting ${initDelay}ms before Firebase initialization...`);
        
        setTimeout(async () => {
            const success = await initializeFirebaseWithLogging();
            console.log('Firebase initialization result:', success);
        }, initDelay);
        
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        window.firebaseDebug = {
            isProduction,
            isDevelopment,
            config: firebaseConfig,
            hostname: window.location.hostname
        };
    </script>
</head>
<body>
    <div class="game-container">
        <div class="start-screen" id="startScreen">
            <h1>NEXUS SERPENT</h1>
            <input type="text" class="nickname-input" id="nicknameInput" placeholder="Enter your nickname" maxlength="15">
            <br>
            <button class="start-btn" id="startBtn">START GAME</button>
            <button class="start-btn" id="viewLeaderboardBtn">VIEW LEADERBOARD</button>
            
            <div id="connectionStatus" style="margin-top: 15px; font-size: 12px; color: #888;">
                üîÑ Connecting to online leaderboard...
            </div>
            
            <!-- –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é -->
            <div id="debugInfo" style="margin-top: 10px; font-size: 10px; color: #666; display: none;">
                Environment: <span id="envInfo">Loading...</span><br>
                Protection: <span id="protectionInfo">Active</span>
            </div>
        </div>

        <div class="leaderboard-screen" id="leaderboardScreen" style="display: none;">
            <h1>üèÜ ONLINE LEADERBOARD</h1>
            <div id="playerCount" style="color: #aaaaaa; margin-bottom: 10px; line-height: 1.4;">
                <div>Total Games: <span id="totalGames">Loading...</span></div>
                <div>Unique Players: <span id="uniquePlayers">Loading...</span></div>
                <div style="font-size: 11px; color: #666;">üåê Live updates</div>
            </div>
            <div class="leaderboard" style="margin-top: 20px;">
                <div id="mainLeaderboardList">
                    <div style="text-align: center; color: #888888; padding: 20px;">
                        üîÑ Loading online scores...
                    </div>
                </div>
            </div>
            <div style="margin-top: 15px;">
                <button class="start-btn" id="backToMenuBtn">BACK TO MENU</button>
                <button class="start-btn" id="refreshLeaderboardBtn" style="background: linear-gradient(145deg, #4CAF50, #45a049); color: white;">üîÑ REFRESH</button>
            </div>
        </div>

        <div class="game-header">
            <div class="score">Score: <span id="scoreValue">0</span></div>
            <div class="game-title">NEXUS SERPENT</div>
            <div class="score">Best: <span id="highScore">0</span></div>
        </div>
        
        <canvas id="gameCanvas"></canvas>
        
        <div class="controls">
            Controls: ‚Üê ‚Üí ‚Üë ‚Üì or WASD | Space - pause
        </div>
    </div>

    <div class="game-over" id="gameOver">
        <h2 style="color: #ffffff; margin-bottom: 10px;">GAME OVER</h2>
        <p style="color: #aaaaaa; margin-bottom: 20px;">Your Score: <span id="finalScore">0</span></p>
        
        <div id="uploadStatus" style="margin-bottom: 15px; font-size: 12px;">
            <span id="uploadMessage">üì§ Uploading to online leaderboard...</span>
        </div>
        
        <div class="leaderboard" id="leaderboard">
            <h3>üèÜ TOP SCORES</h3>
            <div id="leaderboardList">
                <div style="text-align: center; color: #888888;">Loading...</div>
            </div>
        </div>
        
        <button class="restart-btn" id="restartBtn">PLAY AGAIN</button>
    </div>

    <script src="script.js?v=2.2"></script>
    
    <!-- –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—â–∏—Ç—ã -->
    <script>
    setTimeout(() => {
        if (window.APP_PROTECTED) {
            console.log('üõ°Ô∏è All protection systems active');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            const protectionInfo = document.getElementById('protectionInfo');
            if (protectionInfo) {
                protectionInfo.textContent = 'Active ‚úÖ';
                protectionInfo.style.color = '#4CAF50';
            }
        }
    }, 2000);
    </script>
</body>
</html>
